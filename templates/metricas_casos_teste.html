{% extends "base_sb_admin.html" %}

{% block title %}Neurotech - Métricas de Casos de Teste{% endblock %}

{% block page_title %}Métricas de Casos de Teste{% endblock %}

{{ debug_html if debug_html else '<!-- DEBUG: epic_key não fornecido -->' }}
<!-- DEBUG: Verificando se epic_key foi passado -->
<!-- epic_key: {{ epic_key if epic_key else 'NÃO DEFINIDO' }} -->

{% if epic_key %}
<script>
    // Variável global para o epic_key passado via URL
    window.epicKeyFromURL = "{{ epic_key }}";
    console.log('Epic Key definido no template:', window.epicKeyFromURL);
</script>
{% else %}
<script>
    console.log('Nenhum epic_key fornecido no template');
</script>
{% endif %}

{% block content %}
<div class="metrics-container">
    <!-- Header com informações do épico -->
    <div class="epic-header">
        <div class="epic-info">
            <h2 id="epicTitle">Épico {{ epic_key }}</h2>
            <p id="epicSummary">Carregando informações do épico...</p>
            <div class="epic-status">
                <span class="status-badge" id="epicStatus">-</span>
            </div>
        </div>
        <div class="epic-actions">
            <button class="btn btn-outline-primary" onclick="exportarMetricas()">
                <i class="fas fa-download me-1"></i>Exportar Relatório
            </button>
            <button class="btn btn-outline-secondary" onclick="atualizarMetricas()">
                <i class="fas fa-sync-alt me-1"></i>Atualizar
            </button>
        </div>
    </div>

    <!-- Resumo Geral -->
    <div class="summary-section">
        <h3>Resumo Geral</h3>
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="summary-content">
                    <span class="summary-value" id="totalCards">-</span>
                    <span class="summary-label">Cards Relacionados</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="summary-content">
                    <span class="summary-value" id="totalCasosTeste">-</span>
                    <span class="summary-label">Casos de Teste</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="summary-content">
                    <span class="summary-value" id="cardsComCasosTeste">-</span>
                    <span class="summary-label">Cards com Casos de Teste</span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="summary-content">
                    <span class="summary-value" id="taxaSucesso">-</span>
                    <span class="summary-label">Taxa de Sucesso</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Métricas Detalhadas -->
    <div class="metrics-section">
        <h3>Métricas Detalhadas</h3>
        
        <!-- Abas de métricas -->
        <div class="metrics-tabs">
            <button class="tab-button active" onclick="mostrarAba('status')">
                <i class="fas fa-chart-pie"></i> Por Status
            </button>
            <button class="tab-button" onclick="mostrarAba('prioridade')">
                <i class="fas fa-flag"></i> Por Prioridade
            </button>
            <button class="tab-button" onclick="mostrarAba('responsavel')">
                <i class="fas fa-user"></i> Por Responsável
            </button>
            <button class="tab-button" onclick="mostrarAba('hierarquia')">
                <i class="fas fa-sitemap"></i> Hierarquia de Cards
            </button>
        </div>

        <!-- Conteúdo das abas -->
        <div class="tab-content">
            <!-- Aba: Por Status -->
            <div id="status-tab" class="tab-panel active">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h4>Distribuição por Status de Execução</h4>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="metric-card">
                        <h4>Detalhamento por Status</h4>
                        <div class="status-breakdown" id="statusBreakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Aba: Por Prioridade -->
            <div id="prioridade-tab" class="tab-panel">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h4>Distribuição por Prioridade</h4>
                        <canvas id="prioridadeChart"></canvas>
                    </div>
                    <div class="metric-card">
                        <h4>Detalhamento por Prioridade</h4>
                        <div class="prioridade-breakdown" id="prioridadeBreakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Aba: Por Responsável -->
            <div id="responsavel-tab" class="tab-panel">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h4>Distribuição por Responsável</h4>
                        <canvas id="responsavelChart"></canvas>
                    </div>
                    <div class="metric-card">
                        <h4>Detalhamento por Responsável</h4>
                        <div class="responsavel-breakdown" id="responsavelBreakdown"></div>
                    </div>
                </div>
            </div>

            <!-- Aba: Hierarquia de Cards -->
            <div id="hierarquia-tab" class="tab-panel">
                <div class="hierarquia-container">
                    <h4>Hierarquia de Cards e Casos de Teste</h4>
                    <div class="hierarquia-tree" id="hierarquiaTree"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista Detalhada de Casos de Teste -->
    <div class="test-cases-section">
        <h3>Lista Detalhada de Casos de Teste</h3>
        <div class="table-container">
            <table class="metrics-table" id="testCasesTable">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Summary</th>
                        <th>Status</th>
                        <th>Status Execução</th>
                        <th>Responsável</th>
                        <th>Prioridade</th>
                        <th>Criado</th>
                        <th>Atualizado</th>
                    </tr>
                </thead>
                <tbody id="testCasesTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loading-container" style="display: none;">
        <div class="loading-spinner"></div>
        <p>Carregando métricas de casos de teste...</p>
    </div>

    <!-- Error -->
    <div id="error" class="error-container" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <p id="errorMessage">Erro ao carregar métricas</p>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let statusChart = null;
let prioridadeChart = null;
let responsavelChart = null;

// Inicialização quando o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, epic_key:', window.epicKeyFromURL);
    
    if (window.epicKeyFromURL) {
        carregarMetricasCasosTeste(window.epicKeyFromURL);
    }
});

async function carregarMetricasCasosTeste(epicKey) {
    console.log('Carregando métricas de casos de teste para:', epicKey);
    
    // Mostrar loading
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('error').style.display = 'none';

    try {
        const response = await fetch(`/api/metricas-casos-teste/${epicKey}`);
        const data = await response.json();

        console.log('Resposta recebida:', response.status, data);

        if (response.ok) {
            exibirMetricasCasosTeste(data);
        } else {
            throw new Error(data.erro || 'Erro ao carregar métricas de casos de teste');
        }
    } catch (error) {
        console.error('Erro na busca:', error);
        document.getElementById('errorMessage').textContent = error.message;
        document.getElementById('error').style.display = 'flex';
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

function exibirMetricasCasosTeste(data) {
    console.log('Exibindo métricas de casos de teste:', data);
    
    try {
        // Informações do épico
        document.getElementById('epicTitle').textContent = `Épico ${data.epic_key}`;
        document.getElementById('epicSummary').textContent = data.epic_summary || 'Sem descrição';
        document.getElementById('epicStatus').textContent = data.epic_status || 'Desconhecido';
        
        // Resumo geral
        document.getElementById('totalCards').textContent = data.resumo.total_cards;
        document.getElementById('totalCasosTeste').textContent = data.resumo.total_casos_teste;
        document.getElementById('cardsComCasosTeste').textContent = data.resumo.cards_com_casos_teste;
        document.getElementById('taxaSucesso').textContent = `${data.metricas_casos_teste.taxa_sucesso}%`;
        
        // Criar gráficos
        criarGraficoStatus(data.metricas_casos_teste.por_status);
        criarGraficoPrioridade(data.metricas_casos_teste.por_prioridade);
        criarGraficoResponsavel(data.metricas_casos_teste.por_responsavel);
        
        // Preencher detalhamentos
        preencherDetalhamentoStatus(data.metricas_casos_teste.por_status);
        preencherDetalhamentoPrioridade(data.metricas_casos_teste.por_prioridade);
        preencherDetalhamentoResponsavel(data.metricas_casos_teste.por_responsavel);
        
        // Preencher hierarquia
        preencherHierarquia(data.hierarquia_cards);
        
                 // Preencher tabela de casos de teste
         preencherTabelaCasosTeste(data.casos_teste_detalhados);
        
        console.log('Métricas de casos de teste exibidas com sucesso');
    } catch (error) {
        console.error('Erro ao exibir métricas de casos de teste:', error);
    }
}

function criarGraficoStatus(dadosStatus) {
    const ctx = document.getElementById('statusChart');
    if (!ctx) return;
    
    if (statusChart) {
        statusChart.destroy();
    }
    
    const labels = Object.keys(dadosStatus);
    const values = Object.values(dadosStatus);
    const colors = ['#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6c757d'];
    
    statusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function criarGraficoPrioridade(dadosPrioridade) {
    const ctx = document.getElementById('prioridadeChart');
    if (!ctx) return;
    
    if (prioridadeChart) {
        prioridadeChart.destroy();
    }
    
    const labels = Object.keys(dadosPrioridade);
    const values = Object.values(dadosPrioridade);
    const colors = ['#dc3545', '#fd7e14', '#ffc107', '#28a745', '#6c757d'];
    
    prioridadeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Casos de Teste',
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function criarGraficoResponsavel(dadosResponsavel) {
    const ctx = document.getElementById('responsavelChart');
    if (!ctx) return;
    
    if (responsavelChart) {
        responsavelChart.destroy();
    }
    
    const labels = Object.keys(dadosResponsavel);
    const values = Object.values(dadosResponsavel);
    const colors = ['#007bff', '#6610f2', '#6f42c1', '#e83e8c', '#fd7e14'];
    
    responsavelChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function preencherDetalhamentoStatus(dadosStatus) {
    const container = document.getElementById('statusBreakdown');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.entries(dadosStatus).forEach(([status, quantidade]) => {
        const item = document.createElement('div');
        item.className = 'status-item';
        item.innerHTML = `
            <span class="status-name">${status}</span>
            <span class="status-count">${quantidade}</span>
        `;
        container.appendChild(item);
    });
}

function preencherDetalhamentoPrioridade(dadosPrioridade) {
    const container = document.getElementById('prioridadeBreakdown');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.entries(dadosPrioridade).forEach(([prioridade, quantidade]) => {
        const item = document.createElement('div');
        item.className = 'prioridade-item';
        item.innerHTML = `
            <span class="prioridade-name">${prioridade}</span>
            <span class="prioridade-count">${quantidade}</span>
        `;
        container.appendChild(item);
    });
}

function preencherDetalhamentoResponsavel(dadosResponsavel) {
    const container = document.getElementById('responsavelBreakdown');
    if (!container) return;
    
    container.innerHTML = '';
    
    Object.entries(dadosResponsavel).forEach(([responsavel, quantidade]) => {
        const item = document.createElement('div');
        item.className = 'responsavel-item';
        item.innerHTML = `
            <span class="responsavel-name">${responsavel}</span>
            <span class="responsavel-count">${quantidade}</span>
        `;
        container.appendChild(item);
    });
}

function preencherHierarquia(hierarquiaCards) {
    const container = document.getElementById('hierarquiaTree');
    if (!container) return;
    
    container.innerHTML = '';
    
    hierarquiaCards.forEach(card => {
        const cardElement = document.createElement('div');
        cardElement.className = 'hierarquia-card';
        cardElement.innerHTML = `
            <div class="card-header">
                <span class="card-key">${card.card_key}</span>
                <span class="card-type">${card.card_type}</span>
                <span class="card-status">${card.card_status}</span>
            </div>
            <div class="card-summary">${card.card_summary}</div>
            <div class="card-test-cases">
                <span class="test-cases-count">${card.total_casos_teste} casos de teste</span>
                ${card.casos_teste.length > 0 ? `
                    <div class="test-cases-list">
                        ${card.casos_teste.map(caso => `
                            <div class="test-case-item">
                                <span class="test-case-key">${caso.key}</span>
                                <span class="test-case-status">${caso.status_execucao}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
        container.appendChild(cardElement);
    });
}

function preencherTabelaCasosTeste(casosTeste) {
    console.log('Preenchendo tabela de casos de teste:', casosTeste);
    
    const tbody = document.getElementById('testCasesTableBody');
    if (!tbody) {
        console.error('Elemento testCasesTableBody não encontrado!');
        return;
    }
    
    tbody.innerHTML = '';

    if (!casosTeste || casosTeste.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="8" style="text-align: center; color: #666;">Nenhum caso de teste encontrado</td>';
        tbody.appendChild(row);
        return;
    }

    casosTeste.forEach(caso => {
        const row = document.createElement('tr');
        
        // Formatar datas
        const dataCriacao = caso.created ? new Date(caso.created).toLocaleDateString('pt-BR') : '-';
        const dataAtualizacao = caso.updated ? new Date(caso.updated).toLocaleDateString('pt-BR') : '-';
        
        // Determinar cor do status de execução
        const statusExecucao = caso.status_execucao || 'Não Executado';
        let statusClass = 'status-unknown';
        if (statusExecucao.includes('Passou')) statusClass = 'status-success';
        else if (statusExecucao.includes('Falhou')) statusClass = 'status-error';
        else if (statusExecucao.includes('Bloqueado')) statusClass = 'status-warning';
        else if (statusExecucao.includes('Em Execução')) statusClass = 'status-info';
        
        row.innerHTML = `
            <td><a href="https://neurotech.atlassian.net/browse/${caso.key}" target="_blank">${caso.key}</a></td>
            <td>${caso.summary || '-'}</td>
            <td><span class="status-badge">${caso.status || '-'}</span></td>
            <td><span class="status-badge ${statusClass}">${statusExecucao}</span></td>
            <td>${caso.assignee || 'Não Atribuído'}</td>
            <td>${caso.priority || 'Sem Prioridade'}</td>
            <td>${dataCriacao}</td>
            <td>${dataAtualizacao}</td>
        `;
        tbody.appendChild(row);
    });
}

function mostrarAba(aba) {
    // Esconder todas as abas
    document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
    });
    
    // Remover classe active de todos os botões
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Mostrar aba selecionada
    document.getElementById(`${aba}-tab`).classList.add('active');
    
    // Adicionar classe active ao botão clicado
    event.target.classList.add('active');
}

function atualizarMetricas() {
    if (window.epicKeyFromURL) {
        carregarMetricasCasosTeste(window.epicKeyFromURL);
    }
}

function exportarMetricas() {
    // Implementar exportação de relatório
    console.log('Exportando métricas...');
    alert('Funcionalidade de exportação será implementada em breve!');
}
</script>

<style>
.metrics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.epic-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.epic-info h2 {
    margin: 0 0 10px 0;
    color: #333;
}

.epic-summary {
    color: #666;
    margin-bottom: 10px;
}

.epic-actions {
    display: flex;
    gap: 10px;
}

.summary-section {
    margin-bottom: 30px;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.summary-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 15px;
}

.summary-icon {
    font-size: 2rem;
    color: #007bff;
}

.summary-value {
    display: block;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

.summary-label {
    display: block;
    color: #666;
    font-size: 0.9rem;
}

.metrics-section {
    margin-bottom: 30px;
}

.metrics-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 10px;
}

.tab-button {
    background: none;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.tab-button:hover {
    background: #f8f9fa;
}

.tab-button.active {
    background: #007bff;
    color: white;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
}

.metric-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.metric-card h4 {
    margin-bottom: 20px;
    color: #333;
}

.hierarquia-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.hierarquia-card {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
}

.card-header {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.card-key {
    font-weight: bold;
    color: #007bff;
}

.card-type {
    background: #6c757d;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.card-status {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
}

.card-summary {
    margin-bottom: 10px;
    color: #333;
}

.test-cases-count {
    font-weight: bold;
    color: #007bff;
}

.test-cases-list {
    margin-top: 10px;
}

.test-case-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #e9ecef;
}

.test-case-key {
    font-family: monospace;
    color: #007bff;
}

.test-case-status {
    background: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.8rem;
}

.status-item, .prioridade-item, .responsavel-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.status-count, .prioridade-count, .responsavel-count {
    font-weight: bold;
    color: #007bff;
}

.test-cases-section {
    margin-top: 30px;
}

.table-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow-x: auto;
}

.metrics-table {
    width: 100%;
    border-collapse: collapse;
}

.metrics-table th,
.metrics-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.metrics-table th {
    background: #f8f9fa;
    font-weight: bold;
    color: #333;
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
}

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    color: #dc3545;
}

.error-container i {
    font-size: 3rem;
    margin-bottom: 20px;
}

.status-badge {
    background: #28a745;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: bold;
}

.status-success {
    background: #28a745;
}

.status-error {
    background: #dc3545;
}

.status-warning {
    background: #ffc107;
    color: #212529;
}

.status-info {
    background: #17a2b8;
}

.status-unknown {
    background: #6c757d;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
}

.btn-outline-primary {
    background: transparent;
    color: #007bff;
    border: 1px solid #007bff;
}

.btn-outline-primary:hover {
    background: #007bff;
    color: white;
}

.btn-outline-secondary {
    background: transparent;
    color: #6c757d;
    border: 1px solid #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    color: white;
}
</style>
{% endblock %}
