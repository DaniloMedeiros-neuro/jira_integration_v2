{% extends "base.html" %}

{% block title %}Neurotech - Extração de Evidências{% endblock %}

{% block page_title %}Extração de Evidências{% endblock %}

{% block page_subtitle %}Processe e envie evidências de testes automaticamente{% endblock %}

{% block content %}
<div class="evidencias-page">
    <!-- Header da página -->
    <div class="evidencias-header">
        <div class="evidencias-header-content">
            <div class="evidencias-header-info">
                <h2>Sistema de Evidências de Testes</h2>
                <p>Extraia automaticamente evidências visuais de testes e envie-as para o Jira</p>
            </div>
            <div class="evidencias-header-actions">
                <button class="btn btn-outline-primary" onclick="verificarStatusEvidencias()">
                    <i class="fas fa-sync-alt me-1"></i>
                    Verificar Status
                </button>
            </div>
        </div>
    </div>

    <!-- Container principal -->
    <div class="evidencias-container">
        <!-- Seção de Upload -->
        <div class="evidencias-section">
            <div class="evidencias-section-header">
                <h3>
                    <i class="fas fa-upload me-2"></i>
                    Upload de Log de Testes
                </h3>
                <p>Faça upload do arquivo log.html para processar as evidências</p>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <i class="fas fa-file-upload upload-icon"></i>
                    <h4>Arraste o arquivo log.html aqui</h4>
                    <p class="upload-text">ou clique para selecionar o arquivo</p>
                    <input type="file" id="logFileInput" accept=".html" style="display: none;">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('logFileInput').click()">
                        <i class="fas fa-folder-open me-1"></i>
                        Selecionar Arquivo
                    </button>
                </div>
            </div>
            
            <div id="fileInfo" class="file-info" style="display: none;">
                <div class="file-info-content">
                    <i class="fas fa-file-code file-icon"></i>
                    <div class="file-details">
                        <span class="file-name" id="fileName"></span>
                        <span class="file-size" id="fileSize"></span>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerArquivo()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Seção de Processamento -->
        <div class="evidencias-section" id="processamentoSection" style="display: none;">
            <div class="evidencias-section-header">
                <h3>
                    <i class="fas fa-cogs me-2"></i>
                    Processamento de Evidências
                </h3>
                <p>Acompanhe o progresso do processamento das evidências</p>
            </div>
            
            <div class="processamento-steps">
                <div class="step-item" id="step1">
                    <div class="step-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <div class="step-content">
                        <h6>Extrair Screenshots</h6>
                        <p>Captura automática de evidências visuais dos testes</p>
                    </div>
                    <div class="step-status" id="step1Status">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                
                <div class="step-item" id="step2">
                    <div class="step-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="step-content">
                        <h6>Organizar por Status</h6>
                        <p>Separação automática entre testes que passaram e falharam</p>
                    </div>
                    <div class="step-status" id="step2Status">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                
                <div class="step-item" id="step3">
                    <div class="step-icon">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="step-content">
                        <h6>Preparar para Envio</h6>
                        <p>Preparação das evidências para envio ao Jira</p>
                    </div>
                    <div class="step-status" id="step3Status">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
            
            <div class="processamento-actions">
                <button type="button" class="btn btn-primary" id="btnProcessarEvidencias" onclick="processarEvidencias()" style="display: none;">
                    <i class="fas fa-play me-1"></i>
                    Processar Evidências
                </button>
            </div>
        </div>

        <!-- Seção de Resultados -->
        <div class="evidencias-section" id="resultadosSection" style="display: none;">
            <div class="evidencias-section-header">
                <h3>
                    <i class="fas fa-chart-bar me-2"></i>
                    Resultados do Processamento
                </h3>
                <p>Estatísticas das evidências processadas</p>
            </div>
            
            <div class="resultados-stats">
                <div class="stat-item">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-number" id="sucessosCount">0</span>
                        <span class="stat-label">Sucessos</span>
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-icon error">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-number" id="falhasCount">0</span>
                        <span class="stat-label">Falhas</span>
                    </div>
                </div>
                
                <div class="stat-item">
                    <div class="stat-icon info">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-number" id="enviadosCount">0</span>
                        <span class="stat-label">Enviados</span>
                    </div>
                </div>
            </div>
            
            <div class="resultados-actions">
                <button type="button" class="btn btn-outline-primary" onclick="visualizarEvidencias()">
                    <i class="fas fa-eye me-1"></i>
                    Visualizar Evidências
                </button>
                <button type="button" class="btn btn-primary" onclick="enviarEvidenciasJira()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar ao Jira
                </button>
            </div>
        </div>

        <!-- Seção de Histórico -->
        <div class="evidencias-section">
            <div class="evidencias-section-header">
                <h3>
                    <i class="fas fa-history me-2"></i>
                    Histórico de Processamentos
                </h3>
                <p>Últimos processamentos realizados</p>
            </div>
            
            <div class="historico-container">
                <div class="historico-item">
                    <div class="historico-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="historico-content">
                        <h6>log.html</h6>
                        <p>Processado em 25/08/2025 às 10:17</p>
                        <div class="historico-stats">
                            <span class="badge bg-success">14 sucessos</span>
                            <span class="badge bg-danger">4 falhas</span>
                        </div>
                    </div>
                    <div class="historico-actions">
                        <button class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variáveis globais
let uploadedFile = null;

// Inicialização quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    configurarDragAndDrop();
    verificarStatusEvidencias();
});

// Função para configurar drag and drop
function configurarDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('logFileInput');
    
    // Drag and drop events
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });
    
    // Click to select file
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

// Função para lidar com seleção de arquivo
function handleFileSelect(file) {
    if (file.type !== 'text/html' && !file.name.endsWith('.html')) {
        mostrarNotificacao('Por favor, selecione um arquivo HTML válido', 'error');
        return;
    }
    
    uploadedFile = file;
    mostrarInfoArquivo(file);
    document.getElementById('processamentoSection').style.display = 'block';
    document.getElementById('btnProcessarEvidencias').style.display = 'inline-block';
}

// Função para mostrar informações do arquivo
function mostrarInfoArquivo(file) {
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('fileInfo').style.display = 'block';
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
}

// Função para formatar tamanho do arquivo
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Função para remover arquivo
function removerArquivo() {
    uploadedFile = null;
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('processamentoSection').style.display = 'none';
    document.getElementById('btnProcessarEvidencias').style.display = 'none';
    document.getElementById('logFileInput').value = '';
}

// Função para processar evidências
async function processarEvidencias() {
    if (!uploadedFile) {
        mostrarNotificacao('Por favor, selecione um arquivo primeiro', 'warning');
        return;
    }
    
    try {
        // Resetar steps
        resetarSteps();
        
        // Step 1: Extrair screenshots
        await executarStep1();
        
        // Step 2: Organizar por status
        await executarStep2();
        
        // Step 3: Preparar para envio
        await executarStep3();
        
        // Mostrar resultados
        mostrarResultados();
        
    } catch (error) {
        console.error('Erro no processamento:', error);
        mostrarNotificacao('Erro no processamento: ' + error.message, 'error');
    }
}

// Função para resetar steps
function resetarSteps() {
    const steps = ['step1', 'step2', 'step3'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        const status = document.getElementById(stepId + 'Status');
        step.className = 'step-item';
        status.innerHTML = '<i class="fas fa-clock"></i>';
    });
}

// Função para executar Step 1
async function executarStep1() {
    const step = document.getElementById('step1');
    const status = document.getElementById('step1Status');
    
    step.classList.add('active');
    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        // Upload do arquivo
        const formData = new FormData();
        formData.append('log_file', uploadedFile);
        
        const response = await fetch('http://127.0.0.1:8081/api/evidencias/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('Erro no upload do arquivo');
        }
        
        const result = await response.json();
        
        step.classList.remove('active');
        step.classList.add('completed');
        status.innerHTML = '<i class="fas fa-check"></i>';
        
    } catch (error) {
        step.classList.remove('active');
        step.classList.add('error');
        status.innerHTML = '<i class="fas fa-times"></i>';
        throw error;
    }
}

// Função para executar Step 2
async function executarStep2() {
    const step = document.getElementById('step2');
    const status = document.getElementById('step2Status');
    
    step.classList.add('active');
    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        // Simular processamento
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        step.classList.remove('active');
        step.classList.add('completed');
        status.innerHTML = '<i class="fas fa-check"></i>';
        
    } catch (error) {
        step.classList.remove('active');
        step.classList.add('error');
        status.innerHTML = '<i class="fas fa-times"></i>';
        throw error;
    }
}

// Função para executar Step 3
async function executarStep3() {
    const step = document.getElementById('step3');
    const status = document.getElementById('step3Status');
    
    step.classList.add('active');
    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        // Simular processamento
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        step.classList.remove('active');
        step.classList.add('completed');
        status.innerHTML = '<i class="fas fa-check"></i>';
        
    } catch (error) {
        step.classList.remove('active');
        step.classList.add('error');
        status.innerHTML = '<i class="fas fa-times"></i>';
        throw error;
    }
}

// Função para mostrar resultados
function mostrarResultados() {
    document.getElementById('resultadosSection').style.display = 'block';
    
    // Buscar estatísticas reais
    verificarStatusEvidencias();
}

// Função para verificar status das evidências
async function verificarStatusEvidencias() {
    try {
        const response = await fetch('http://127.0.0.1:8081/api/evidencias/status');
        
        if (response.ok) {
            const data = await response.json();
            
            document.getElementById('sucessosCount').textContent = data.sucessos || 0;
            document.getElementById('falhasCount').textContent = data.falhas || 0;
            document.getElementById('enviadosCount').textContent = data.enviados || 0;
            
            if (data.processado) {
                document.getElementById('resultadosSection').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Erro ao verificar status:', error);
    }
}

// Função para visualizar evidências
function visualizarEvidencias() {
    mostrarNotificacao('Funcionalidade de visualização será implementada em breve', 'info');
}

// Função para enviar evidências ao Jira
async function enviarEvidenciasJira() {
    try {
        mostrarNotificacao('Enviando evidências ao Jira...', 'info');
        
        const response = await fetch('http://127.0.0.1:8081/api/evidencias/enviar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            const result = await response.json();
            document.getElementById('enviadosCount').textContent = result.enviados || 0;
            mostrarNotificacao('Evidências enviadas com sucesso!', 'success');
        } else {
            throw new Error('Erro ao enviar evidências');
        }
        
    } catch (error) {
        console.error('Erro:', error);
        mostrarNotificacao('Erro ao enviar evidências: ' + error.message, 'error');
    }
}

// Função para mostrar notificações
function mostrarNotificacao(mensagem, tipo) {
    // Implementar sistema de notificações
    console.log(`${tipo.toUpperCase()}: ${mensagem}`);
}
</script>
{% endblock %}
