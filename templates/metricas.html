{% extends "base_sb_admin.html" %}

{% block title %}Neurotech - Métricas Administrativas{% endblock %}

{% block page_title %}Métricas Administrativas{% endblock %}

{% block content %}
<!-- Filtros Section -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-filter fa-fw me-2"></i>Filtros
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <label class="font-weight-bold text-gray-800">Projeto</label>
                    <select class="form-control" id="projetoSelect">
                        <option value="">Todos os Projetos</option>
                        <option value="BC">BC</option>
                        <option value="NEURO">NEURO</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="font-weight-bold text-gray-800">Período</label>
                    <select class="form-control" id="periodoSelect">
                        <option value="7">Últimos 7 dias</option>
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="365">Último ano</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="font-weight-bold text-gray-800">Status</label>
                    <select class="form-control" id="statusSelect">
                        <option value="">Todos os Status</option>
                        <option value="To Do">To Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-group">
                    <label class="font-weight-bold text-gray-800">&nbsp;</label>
                    <button type="button" class="btn btn-primary btn-block" onclick="aplicarFiltros()">
                        <i class="fas fa-search me-1"></i>Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Métricas do Épico Section -->
<div class="card shadow mb-4" id="metricasEpico" style="display: none;">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-chart-line fa-fw me-2"></i>Métricas do Épico
        </h6>
        <div class="dropdown no-arrow">
            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                <div class="dropdown-header">Ações:</div>
                <a class="dropdown-item" href="#" onclick="exportarMetricas()">
                    <i class="fas fa-download fa-sm fa-fw mr-2 text-gray-400"></i>Exportar
                </a>
                <a class="dropdown-item" href="#" onclick="atualizarMetricas()">
                    <i class="fas fa-sync fa-sm fa-fw mr-2 text-gray-400"></i>Atualizar
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <!-- Cards de Métricas -->
        <div class="row">
            <!-- Progresso -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    <i class="fas fa-tasks me-1"></i>Progresso
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="percentualConclusao">-</div>
                                <div class="text-xs text-gray-600">
                                    <span id="issuesConcluidas">-</span> de <span id="totalIssues">-</span> issues
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tasks fa-2x text-gray-300"></i>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Story Points -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    <i class="fas fa-chart-pie me-1"></i>Story Points
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="storyPointsConcluidos">-</div>
                                <div class="text-xs text-gray-600">
                                    de <span id="storyPointsTotal">-</span> total
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-chart-pie fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tempo -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    <i class="fas fa-clock me-1"></i>Cycle Time
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="cycleTimeMedio">-</div>
                                <div class="text-xs text-gray-600">dias em média</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-clock fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Velocidade -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    <i class="fas fa-tachometer-alt me-1"></i>Velocidade
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="velocidadeMedia">-</div>
                                <div class="text-xs text-gray-600">points/sprint</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tachometer-alt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos Section -->
        <div class="row">
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-area fa-fw me-2"></i>Progresso ao Longo do Tempo
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-chart-pie fa-fw me-2"></i>Distribuição por Status
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Issues Section -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-table fa-fw me-2"></i>Issues do Épico
        </h6>
        <div class="dropdown no-arrow">
            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
            </a>
            <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                <div class="dropdown-header">Ações:</div>
                <a class="dropdown-item" href="#" onclick="exportarTabela()">
                    <i class="fas fa-download fa-sm fa-fw mr-2 text-gray-400"></i>Exportar CSV
                </a>
                <a class="dropdown-item" href="#" onclick="filtrarTabela()">
                    <i class="fas fa-filter fa-sm fa-fw mr-2 text-gray-400"></i>Filtrar
                </a>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="issuesTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>Key</th>
                        <th>Summary</th>
                        <th>Status</th>
                        <th>Story Points</th>
                        <th>Assignee</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="issuesTableBody">
                    <!-- Dados serão carregados dinamicamente -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loadingModalLabel">
                    <i class="fas fa-spinner fa-spin me-2"></i>Carregando...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p class="mb-0">Carregando métricas, aguarde...</p>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>Erro
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="errorMessage">Ocorreu um erro ao carregar as métricas.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="tentarNovamente()">Tentar Novamente</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variáveis globais
let epicKey = null;
let metricasData = null;
let progressChart = null;
let statusChart = null;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se há epic_key na URL
    const urlParams = new URLSearchParams(window.location.search);
    epicKey = urlParams.get('epic_key') || 'BC-8'; // Default para teste
    
    if (epicKey) {
        carregarMetricas(epicKey);
    } else {
        mostrarErro('Nenhum épico especificado.');
    }
});

// Carregar métricas
async function carregarMetricas(epicKey) {
    try {
        $('#loadingModal').modal('show');
        
        const response = await fetch(`/api/metricas/epico/${epicKey}`);
        const data = await response.json();
        
        if (data.sucesso) {
            metricasData = data.dados;
            exibirMetricas(metricasData);
            criarGraficos(metricasData);
            $('#loadingModal').modal('hide');
        } else {
            throw new Error(data.erro || 'Erro ao carregar métricas');
        }
        
    } catch (error) {
        console.error('Erro ao carregar métricas:', error);
        $('#loadingModal').modal('hide');
        mostrarErro('Erro ao carregar métricas: ' + error.message);
    }
}

// Exibir métricas
function exibirMetricas(data) {
    // Atualizar cards
    document.getElementById('totalIssues').textContent = data.total_issues || 0;
    document.getElementById('issuesConcluidas').textContent = data.issues_concluidas || 0;
    document.getElementById('percentualConclusao').textContent = data.percentual_conclusao || '0%';
    document.getElementById('storyPointsTotal').textContent = data.story_points_total || 0;
    document.getElementById('storyPointsConcluidos').textContent = data.story_points_concluidos || 0;
    document.getElementById('cycleTimeMedio').textContent = data.cycle_time_medio || '-';
    document.getElementById('velocidadeMedia').textContent = data.velocidade_media || '-';
    
    // Atualizar barra de progresso
    const progressBar = document.getElementById('progressBar');
    const percentual = data.percentual_conclusao || 0;
    progressBar.style.width = percentual + '%';
    progressBar.textContent = percentual + '%';
    
    // Mostrar seção de métricas
    document.getElementById('metricasEpico').style.display = 'block';
    
    // Carregar tabela de issues
    carregarTabelaIssues(data.issues || []);
}

// Criar gráficos
function criarGraficos(data) {
    // Gráfico de progresso
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    progressChart = new Chart(progressCtx, {
        type: 'line',
        data: {
            labels: data.labels_progresso || [],
            datasets: [{
                label: 'Progresso (%)',
                data: data.dados_progresso || [],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // Gráfico de status
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: data.labels_status || [],
            datasets: [{
                data: data.dados_status || [],
                backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b', '#858796']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Carregar tabela de issues
function carregarTabelaIssues(issues) {
    const tbody = document.getElementById('issuesTableBody');
    tbody.innerHTML = '';
    
    issues.forEach(issue => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><a href="#" onclick="abrirIssue('${issue.key}')">${issue.key}</a></td>
            <td>${issue.summary}</td>
            <td><span class="badge badge-${getStatusColor(issue.status)}">${issue.status}</span></td>
            <td>${issue.story_points || '-'}</td>
            <td>${issue.assignee || '-'}</td>
            <td>${formatarData(issue.created)}</td>
            <td>${formatarData(issue.updated)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="abrirIssue('${issue.key}')">
                    <i class="fas fa-external-link-alt"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Utilitários
function getStatusColor(status) {
    switch (status) {
        case 'Done': return 'success';
        case 'In Progress': return 'warning';
        case 'To Do': return 'secondary';
        default: return 'info';
    }
}

function formatarData(dataString) {
    if (!dataString) return '-';
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR');
}

function mostrarErro(mensagem) {
    document.getElementById('errorMessage').textContent = mensagem;
    $('#errorModal').modal('show');
}

function tentarNovamente() {
    $('#errorModal').modal('hide');
    if (epicKey) {
        carregarMetricas(epicKey);
    }
}

function aplicarFiltros() {
    // Implementar filtros
    console.log('Aplicando filtros...');
}

function exportarMetricas() {
    // Implementar exportação
    console.log('Exportando métricas...');
}

function atualizarMetricas() {
    if (epicKey) {
        carregarMetricas(epicKey);
    }
}

function exportarTabela() {
    // Implementar exportação CSV
    console.log('Exportando tabela...');
}

function filtrarTabela() {
    // Implementar filtros da tabela
    console.log('Filtrando tabela...');
}

function abrirIssue(issueKey) {
    // Abrir issue no Jira
    window.open(`https://your-domain.atlassian.net/browse/${issueKey}`, '_blank');
}
</script>
{% endblock %}
